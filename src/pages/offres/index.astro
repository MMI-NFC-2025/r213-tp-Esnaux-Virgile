---
import "../../styles/global.css";
import Layout from "../../layouts/Layout.astro";
import OffreCard from "../../components/OffreCard.astro";
import { getOffres } from "../../backend.old.mjs";

// Récupérer les données depuis PocketBase
const offres = await getOffres();
---

<Layout title="Offres">
    <h1>Hello, voici les offres!</h1>
    <button id="favori-button" class="bg-slate-600 rounded-lg text-white p-2">
        Afficher les favoris
    </button>

    <div class="surface-filters">
        <span>Filtrer par surface minimum:</span>
        <a href="/offres/surface/20">20m²</a>
        <a href="/offres/surface/50">50m²</a>
        <a href="/offres/surface/80">80m²</a>
        <a href="/offres/surface/100">100m²</a>
        <a href="/offres/surface/200">200m²</a>
        <a href="/offres/surface/400">400m²</a>
    </div>

    <div class="offres-container">
        {
            offres.map((offre) => (
                <div class="offre" data-favori={offre.favori.toString()}>
                    <OffreCard record={offre} />
                </div>
            ))
        }
    </div>
</Layout>

<script>
    const button = document.getElementById("favori-button");
    let showOnlyFavorites = false;
    button?.addEventListener("click", () => {
        showOnlyFavorites = !showOnlyFavorites;
        const offres = document.querySelectorAll(".offre");

        button.textContent = showOnlyFavorites
            ? "Afficher tout"
            : "Afficher les favoris";

        offres.forEach((offre) => {
            const isFavori = offre.getAttribute("data-favori") === "true";
            offre.classList.toggle("hidden", showOnlyFavorites && !isFavori);
        });
    });

    // Gestion des boutons favoris sur chaque card
    const favoriBtns = document.querySelectorAll(".favori-btn");
    favoriBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const isFavori = btn.getAttribute("data-favori") === "true";
            const newFavori = !isFavori;

            btn.setAttribute("data-favori", newFavori.toString());
            btn.textContent = newFavori ? "⭐ Favori" : "☆ Favori";

            // Mettre à jour l'apparence de la card
            const offreCard = btn.closest(".offre-card");
            if (offreCard) {
                offreCard.classList.toggle("favori", newFavori);
            }

            // Mettre à jour l'attribut data-favori du conteneur parent
            const offreContainer = btn.closest(".offre");
            if (offreContainer) {
                offreContainer.setAttribute(
                    "data-favori",
                    newFavori.toString(),
                );

                // Si le filtre est actif, cacher la card si elle n'est plus favorite
                if (showOnlyFavorites && !newFavori) {
                    offreContainer.classList.add("hidden");
                }
            }
        });
    });
</script>

<style>
    .offres-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        justify-items: center;
    }

    .offre {
        display: flex;
        width: 100%;
        max-width: 400px;
    }

    .offre.hidden {
        display: none;
    }
</style>
